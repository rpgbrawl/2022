class TMFColorParser{constructor(t=""){this.autoContrastColor(t),this.links=null,this.manialinks=null,this.background=null,this.forceDarken=!1,this.forceBrighten=!1,this.convert=null,this.alwaysDrawFontShadows=!0}replace(t,e,s){const h=new RegExp(t,"g");return s.replace(h,e)}getStyledString(t,{length:e},s,h,r,a,f,l){let n=t.substring(e).trim(),$="";if(a&&(n=n.toUpperCase()),(s||h||r||f)&&n){if(s&&!l){const o=this.get_rgb(`#${s}`),m=this.getContrastCorrectedColor(o);let g=this.get_hex(m);null!==this.convert&&null!==this.convert[0]&&(g=this.convertHex(g,this.convert[0],this.convert[1])),$+=`color:${g};`}f&&($+="font-style:italic;"),h&&($+="font-weight:bold;"),r&&($+="letter-spacing: -0.1em;font-size:smaller;")}return[n,$]}linkIsIP(t){return t.match(/\\A\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*\\z/)}fixWWWLinks(){for(const t in this.links){let e=this.links[t].trim();("www."===e.toLowerCase().substring(0,4)||this.linkIsIP(e))&&(e=`http://${e}`,this.links[t]=e)}}parseLinks(t,e=!0){let s=this.parseManialinks(t,e);s=this.replace("\\$L","$l",s),this.links={};let h=0;const r=s.split("$l");return r.forEach((a,f)=>{if(f%2==1){const l=`{LINK${h}}`;if(h+=1,a.match(/^\[(.*)\](.*)/)){let n=a.substring(a.indexOf("[")+1);n=n.substring(0,n.indexOf("]")),this.links[l]=n,r[f]=e?`$a${l}$x${a.substring(a.indexOf("]")+1)}$a{/LINK}$x`:a.substring(a.indexOf("]")+1)}else this.links[l]=a,e&&(r[f]=`$a${l}$x${a}$a{/LINK}$x`)}}),this.fixWWWLinks(),r.join("")}parseManialinks(t,e=!0){this.manialinks={};const h=this.replace("\\$H","$h",t).split("$h");let r=0,a=0;for(;a<h.length;a+=1){const f=h[a];if(a%2==1){const l=`{MLINK${r}}`;if(r+=1,f.match(/\A\[(.*)\](.*)\Z/)){let n=f.substring(f.indexOf("[")+1);n=n.substring(0,n.indexOf("]")),this.manialinks[l]=n,h[a]=e?`$a${l}$x${f.substring(f.indexOf("]")+1)}$a{/LINK}$x`:f.substring(f.indexOf("]")+1)}else this.manialinks[l]=f,e&&(h[a]=`$a${l}$x${f}$a{/LINK}$x`)}}return h.join("")}insertLinks(t){let e=t;for(const s in this.manialinks)e=this.replace(s,`<a href="tmtp:///:${this.manialinks[s]}">`,e);for(const s in this.links)e=this.replace(s,`<a href="${this.links[s]}">`,e);return e=this.replace("{/LINK}","</a>",e),e}getColorBrightness({r:t,g:e,b:s}){return(299*t+587*e+114*s)/1e3}getBrightnessDifference(t,e){return Math.abs(this.getColorBrightness(t)-this.getColorBrightness(e))}getColorDifference({r:t,g:e,b:s},{r2:h,g2:r,b2:a}){return(Math.abs(t-h)+Math.abs(e-r)+Math.abs(s-a))/768*100}autoContrastColor(t){this.background=this.get_rgb(t)}replaceHex(t,e){this.convert=[t,e]}convertHex(t,e,s){return this.replace(e,s,string)}getContrastCorrectedColor(t){if(!this.background)return t;const e=t,s=t,r=(this.getColorDifference(t,this.background),this.get_rgb("#ffffff")),a=this.get_rgb("#000000"),l=50;let n=255,$=255,o=1;for(;o<=l;o+=1){const i=this.getColorDifference(e,this.background),c=this.getColorDifference(s,this.background);i<15?(e.r=(l-o)/l*t.r+o/l*r.r,e.g=(l-o)/l*t.g+o/l*r.g,e.b=(l-o)/l*t.b+o/l*r.b):$=this.getColorDifference(e,t),c<15?(s.r=(l-o)/l*t.r+o/l*a.r,s.g=(l-o)/l*t.g+o/l*a.g,s.b=(l-o)/l*t.b+o/l*a.b):n=this.getColorDifference(s,t)}const m=Math.abs(15-this.getColorDifference(e,this.background)),g=Math.abs(15-this.getColorDifference(s,this.background));return this.forceDarken?s:this.forceBrighten||$<n?e:$>n||g<m?s:e}toHTML(t,e=!1,s=!0,h=""){let r=!1,a=!1,f=!1,l=!1,n=!1,$=!1,o=t,m=h;"all"===m.toLowerCase()&&(m="iwonstmgaxz"),m.split("").forEach((i,c)=>{const p=m.substring(c,parseInt(c+1,10));o=this.replace(`\\$${p}`,"",o)}),o=this.replace("\\$\\$","[DOLLAR]",o),o=this.replace(" ","&nbsp;",o),o=this.parseLinks(o,!s);let g=o.split("$");return 1==g.length?(g=this.workChunksArray(g),g.filter(i=>i.length||i)):(g.forEach((i,c)=>{let p,b,S,x,D,d;(d=i.match(/^[0-9a-f]{2,3}/i))?(r=d[0],r.length<3&&(r+=8),r=r[0]+r[0]+r[1]+r[1]+r[2]+r[2],g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(i)/i))?(n=!0,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(w)/i))||(d=i.match(/^(o)/i))?(f=!1,a=!0,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(n)/i))?(a=!1,f=!0,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(s)/i))?g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e):(d=i.match(/^(t)/i))?(l=!0,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(m)/i))?(a=!1,$=!1,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(g)/i))?(r=!1,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(a)/i))?(p=r,b=a,S=f,x=l,D=n,r=!1,a=!1,f=!1,l=!1,n=!1,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(x)/i))?(r=p,a=b,f=S,l=x,n=D,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e)):(d=i.match(/^(z)/i))&&(r=!1,a=!1,f=!1,l=!1,n=!1,g[c]=this.getStyledString(i,d[0],r,a,f,l,n,e))}),g=this.workChunksArray(g),g.filter(i=>i.length||i))}workChunksArray(t){return t[0]=[t[0]," "],t.forEach((e,s)=>{("string"==typeof t[s][0]||t[s][0]instanceof String)&&(t[s][0]=t[s][0].replace("[DOLLAR]+","$",e),t[s][0]=t[s][0].replace("&NBSP;","&nbsp;",e),t[s][0]=t[s][0].replaceAll(new RegExp("&nbsp;","g")," ",e))}),t}toArray(t){let e=!1,s=!1,h=!1,r=!1,a=!1,f=!1;const n=this.parseLinks(this.replace("\\$\\$","[DOLLAR]",t),!1).split("$"),$=[];return n[0]&&($[0].text=this.replace("[DOLLAR]+","$",n[0])),n.forEach((o,m)=>{let i,g="";if((i=o.match(/^[0-9a-f]{2,3}/i))?(e=i[0],g=e,e.length<3&&(e+=9),e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]):(i=o.match(/^(i)/i))?(g=i[0],a=!0):(i=o.match(/^(w)/i))||(i=o.match(/^(o)/i))?(g=i[0],h=!1,s=!0):(i=o.match(/^(n)/i))?(g=i[0],s=!1,h=!0):(i=o.match(/^(s)/i))?(g=i[0],f=!0):(i=o.match(/^(t)/i))?(g=i[0],r=!0):(i=o.match(/^(m)/i))?(g=i[0],s=!1,bold=!1):(i=o.match(/^(g)/i))?(g=i[0],e=!1):(i=o.match(/^(x)/i))?g=i[0]:(i=o.match(/^(z)/i))&&(g=i[0],f=!1,e=!1,s=!1,h=!1,r=!1,a=!1),o.substring(g.length)){const c=$.length;$[c].text=this.replace("[DOLLAR]+","$",o),$[c].italic=a,$[c].narrow=h,$[c].wide=s,$[c].caps=r,$[c].shadow=f,$[c].color=e}}),$}get_rgb(t){const e=t.replace("#",""),s={};return s.r=parseInt(e.substring(0,2),16),s.g=parseInt(e.substring(2,4),16),s.b=parseInt(e.substring(4,6),16),s}get_hex({r:t,g:e,b:s}){return`#${[t,e,s].map(h=>{const r=h.toString(16);return 1===r.length?`0${r}`:r}).join("")}`}forceDarkerColors(){this.forceDarken=!0,this.forceBrighten=!1}forceBrighterColors(){this.forceDarken=!1,this.forceBrighten=!0}forceAutomaticColorCorrection(){this.forceDarken=!1,this.forceBrighten=!1}}